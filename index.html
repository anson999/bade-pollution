<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç©ºæ°£æ±¡æŸ“æ•¸æ“šæ•…äº‹å ±å‘Š - å³æ™‚æ›´æ–°ç‰ˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate-50 */
            scroll-behavior: smooth;
        }
        .section-padding {
            padding: 4rem 1.5rem;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        /* Override for full-width charts like the trend chart */
        .chart-container.full-width {
            max-width: 100%;
        }

        @media (min-width: 640px) {
            .chart-container {
                height: 350px;
            }
        }
        .metric-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-left-width: 5px;
            transition: all 0.5s ease-in-out;
        }
        .active-update {
            animation: pulse-update 0.5s 3;
        }
        @keyframes pulse-update {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(1); box-shadow: none; }
        }
    </style>
</head>
<body class="pt-20">

    <!-- Sticky Navigation Header -->
    <header class="fixed top-0 left-0 right-0 bg-white shadow-md z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center p-4">
            <h1 class="text-xl font-bold text-gray-900">å¤§èˆˆé‡Œæ±¡æŸ“å ±å‘Š (å³æ™‚)</h1>
            <nav class="space-x-4 flex">
                <a href="#overview" class="text-gray-600 hover:text-blue-600 font-medium transition duration-150">ç¸½é«”æ¦‚æ³</a>
                <a href="#time-loc" class="text-gray-600 hover:text-blue-600 font-medium transition duration-150">æ™‚é–“èˆ‡åœ°é»</a>
                <a href="#health-impact" class="text-gray-600 hover:text-blue-600 font-medium transition duration-150">å¥åº·å½±éŸ¿</a>
                <a href="#conclusion" class="text-gray-600 hover:text-blue-600 font-medium transition duration-150">è¡Œå‹•å»ºè­°</a>
            </nav>
            <div id="last-update" class="text-sm text-gray-500">
                è¼‰å…¥ä¸­...
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto bg-white shadow-xl rounded-xl mt-4 overflow-hidden">
        
        <!-- Section 1: Overview & Key Metrics -->
        <section id="overview" class="section-padding bg-gray-50 border-b-8 border-blue-600">
            <div class="text-center mb-10">
                <h2 class="text-4xl font-extrabold text-gray-900 mb-2">ç¸½é«”æ¦‚æ³ï¼šé—œéµæ•¸æ“šæŒ‡æ¨™</h2>
                <p class="text-lg text-gray-600">
                    æœ¬ç¯€ç¸½çµäº†ç©ºæ°£æ±¡æŸ“å›å ±å–®çš„æ ¸å¿ƒé‡åŒ–æ•¸æ“šï¼Œé‡é»å±•ç¤ºç•°å‘³çš„åš´é‡ç¨‹åº¦èˆ‡ç™¼ç”Ÿç’°å¢ƒã€‚
                    <span id="loading-status" class="text-sm text-red-500 font-medium"></span>
                </p>
            </div>
            
            <!-- Metric Cards: Initial values set to 0, will be updated by script -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto mb-12">
                <div id="card-n" class="metric-card border-red-500">
                    <p class="text-lg font-semibold text-gray-700">ç¸½å›å ±æ•¸ (N)</p>
                    <p class="text-5xl font-bold text-red-600" id="metric-n">0</p>
                </div>
                <div id="card-heavy" class="metric-card border-yellow-500">
                    <p class="text-lg font-semibold text-gray-700">é‡åº¦ç•°å‘³ä½”æ¯”</p>
                    <p class="text-5xl font-bold text-yellow-600" id="metric-heavy-percent">0%</p>
                </div>
                <div id="card-outdoor" class="metric-card border-blue-500">
                    <p class="text-lg font-semibold text-gray-700">å®¤å¤–ç™¼ç”Ÿä½”æ¯”</p>
                    <p class="text-5xl font-bold text-blue-600" id="metric-outdoor-percent">0%</p>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                <div>
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700 text-center">æ°£å‘³æ¿ƒåº¦åˆ†ä½ˆ</h3>
                    <div class="chart-container">
                        <canvas id="concentrationPieChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700 text-center">ç™¼ç”Ÿåœ°é»åˆ†é¡</h3>
                    <div class="chart-container">
                        <canvas id="locationPieChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Time and Location Analysis -->
        <section id="time-loc" class="section-padding bg-white border-b border-gray-200">
            <h2 class="text-4xl font-extrabold text-gray-900 mb-8 text-center">æ±¡æŸ“è¦å¾‹ï¼šæ™‚é–“èˆ‡æ½›åœ¨ä¾†æºåˆ†æ</h2>
            <p class="text-lg text-gray-700 max-w-3xl mx-auto mb-10 text-center">
                åˆ†ææ•¸æ“šæ­ç¤ºäº†æ˜ç¢ºçš„æ™‚ç©ºé›†ä¸­æ€§ï¼Œé€™å°æ–¼è¦åŠƒç¨½æŸ¥èˆ‡ç›£æ¸¬æœ‰æ±ºå®šæ€§çš„å¹«åŠ©ã€‚
            </p>
            
            <!-- Time Peaks and Source Clues -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12 max-w-5xl mx-auto mb-16">
                <!-- Time Peaks -->
                <div class="bg-blue-50 p-8 rounded-xl border-l-4 border-blue-500">
                    <h3 class="text-2xl font-bold text-blue-800 mb-4">ç•°å‘³ç™¼ç”Ÿé«˜å³°æ™‚æ®µ</h3>
                    <ul class="space-y-3 list-disc list-inside text-gray-700 text-lg" id="time-peaks-list">
                        <!-- Content will be generated by script based on live data analysis -->
                        <li>**å ±å‘Šç¸½æ•¸ï¼š** 0 å‰‡ (å³æ™‚æ›´æ–°)</li>
                        <li>**é‡åº¦ä½”æ¯”ï¼š** 0%</li>
                        <li><span class="font-bold text-red-600">**æœ€å¸¸ç™¼ç”Ÿç—‡ç‹€ï¼š** è¼‰å…¥ä¸­...</span></li>
                    </ul>
                </div>
                
                <!-- Location and Source -->
                <div class="bg-yellow-50 p-8 rounded-xl border-l-4 border-yellow-500">
                    <h3 class="text-2xl font-bold text-yellow-800 mb-4">å€åŸŸç†±é»èˆ‡æ±¡æŸ“æºç·šç´¢</h3>
                    <p class="text-lg font-semibold text-gray-700 mb-3">ä¸»è¦å—å½±éŸ¿å€åŸŸ:</p>
                    <ul class="space-y-2 list-disc list-inside text-gray-700">
                        <li>ã€Œä¸‰æœ¬åƒæ™´ã€ç¤¾å€ (å¤šç­†å›å ±)</li>
                        <li>å¤§èˆˆè·¯ 96-108 è™Ÿæ²¿ç·š</li>
                    </ul>
                    <p class="text-lg font-semibold text-gray-700 mt-4 mb-2">æ½›åœ¨æ±¡æŸ“æº (å±…æ°‘æåŠ):</p>
                    <blockquote class="bg-yellow-100 p-3 border-l-4 border-yellow-600 italic text-yellow-800">
                        ã€ŒéŒ«å®‰å…¬å¸é…¸è‡­å‘³ï¼Œå››è™•æ“´æ•£ã€
                    </blockquote>
                </div>
            </div>
            
            <!-- Daily Trend Bar Chart (Now full width section) -->
            <div class="max-w-6xl mx-auto">
                <h3 class="text-3xl font-bold text-gray-800 mb-6 text-center" id="trend-chart-title">æ¯æ—¥å›å ±æ•¸é‡åˆ†ä½ˆç›´æ–¹åœ–</h3>
                <div class="bg-white p-6 rounded-xl shadow-lg border-2 border-gray-100">
                    <div class="chart-container full-width" style="height: 350px;">
                        <canvas id="trendLineChart"></canvas>
                    </div>
                </div>
            </div>
            
        </section>

        <!-- Section 3: Health Impact -->
        <section id="health-impact" class="section-padding bg-gray-50 border-b border-gray-200">
            <h2 class="text-4xl font-extrabold text-gray-900 mb-8 text-center">å¥åº·è­¦ç¤ºï¼šå±…æ°‘ä¸è‰¯åæ‡‰çµ±è¨ˆ</h2>
            <p class="text-lg text-gray-700 max-w-3xl mx-auto mb-10 text-center">
                ç•°å‘³å·²å°å±…æ°‘å¥åº·é€ æˆå¯¦è³ªå½±éŸ¿ã€‚æœ¬åˆ†æçµ±è¨ˆäº†æ‰€æœ‰å›å ±ä¸­çš„ä¸è‰¯åæ‡‰æ¬¡æ•¸ (<span id="reaction-n-count" class="font-bold">N=0</span> æ¬¡)ï¼Œä¸¦æŒ‰ç—‡ç‹€åˆ†é¡ã€‚
            </p>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 max-w-5xl mx-auto">
                <div class="lg:col-span-1 p-6 bg-white rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">ç•°å‘³é¡å‹ç´°åˆ†</h3>
                    <div class="space-y-4">
                        <div class="p-4 bg-red-100 rounded-lg">
                            <p class="text-lg font-bold text-red-700">è‡­é…¸å‘³ (Foul/Acidic)</p>
                            <p class="text-sm text-red-600" id="odor-foul-count">è¼‰å…¥ä¸­...</p>
                        </div>
                        <div class="p-4 bg-orange-100 rounded-lg">
                            <p class="text-lg font-bold text-orange-700">å—†é¼»å‘³ (Pungent)</p>
                            <p class="text-sm text-orange-600" id="odor-pungent-count">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
                
                <div class="lg:col-span-2 p-6 bg-white rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">ä¸è‰¯åæ‡‰æ¬¡æ•¸é•·æ¢åœ–</h3>
                    <div class="chart-container" style="max-width: 100%; height: 350px;">
                        <canvas id="reactionBarChart"></canvas>
                    </div>
                    <p class="text-red-600 font-bold mt-4 border-l-4 border-red-300 pl-3">
                        è­¦ç¤ºï¼šæ•¸æ“šé¡¯ç¤ºå™å¿ƒå’Œé ­æšˆé€šå¸¸æ˜¯æœ€å¸¸è¦‹çš„å¥åº·ç—‡ç‹€ã€‚
                    </p>
                </div>
            </div>
        </section>

        <!-- Section 4: Conclusion and Recommendations -->
        <section id="conclusion" class="section-padding bg-white">
            <h2 class="text-4xl font-extrabold text-gray-900 mb-8 text-center">çµè«–èˆ‡å¾ŒçºŒè¡Œå‹•æ–¹æ¡ˆ</h2>
            <p class="text-lg text-gray-700 max-w-3xl mx-auto mb-10 text-center">
                æ ¹æ“šæ‰€æœ‰æ•¸æ“šé»ï¼Œæˆ‘å€‘ç¢ºç«‹äº†å››é …é—œéµçµè«–ä¸¦æå‡ºå³åˆ»åŸ·è¡Œçš„ä¸‰é …è¡Œå‹•æ–¹æ¡ˆã€‚
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12 max-w-5xl mx-auto">
                <!-- Key Conclusions -->
                <div class="p-8 rounded-xl bg-blue-100 border-l-4 border-blue-600">
                    <h3 class="text-2xl font-bold text-blue-800 mb-4">å››é …é—œéµçµè«–</h3>
                    <ol class="space-y-3 list-decimal list-inside text-gray-700 text-lg pl-4">
                        <li>äº‹ä»¶åš´é‡ (<span id="conc-heavy-percent">0</span>% é‡åº¦)ï¼Œç•°å‘³å…·é…¸æ€§èˆ‡åˆºæ¿€æ€§ã€‚</li>
                        <li>æ™‚é–“è¦å¾‹ï¼Œé«˜å³°æ™‚æ®µæ˜ç¢ºï¼Œåˆ©æ–¼ç¨½æŸ¥ã€‚</li>
                        <li>åœ°é»é›†ä¸­ï¼Œä¾†æºæŒ‡å‘ç‰¹å®šå·¥å» ã€‚</li>
                        <li>å·²é€ æˆæ˜é¡¯å¥åº·å½±éŸ¿ï¼Œéœ€ç·Šæ€¥è™•ç†ã€‚</li>
                    </ol>
                </div>
                <!-- Action Plan -->
                <div class="p-8 rounded-xl bg-green-100 border-l-4 border-green-600">
                    <h3 class="text-2xl font-bold text-green-800 mb-4">ç«‹å³è¡Œå‹•æ–¹æ¡ˆ</h3>
                    <ul class="space-y-3 list-disc list-inside text-green-700 text-lg font-medium pl-4">
                        <li>**çªæ“Šç¨½æŸ¥ï¼š** é‡å°ã€ŒéŒ«å®‰å·¥å» ã€å‘¨é‚Šï¼Œæ–¼é«˜å³°æ™‚æ®µå¯¦æ–½ã€‚</li>
                        <li>**ç’°å¢ƒç›£æ¸¬ï¼š** æ–¼ç†±é»ï¼ˆå¦‚ä¸‰æœ¬åƒæ™´ï¼‰è¨­ç½®è‡¨æ™‚ç›£æ¸¬ç«™ã€‚</li>
                        <li>**è³‡è¨Šé€æ˜ï¼š** å®šæœŸå‘é‡Œæ°‘å…¬é–‹è™•ç†é€²åº¦ã€‚</li>
                    </ul>
                </div>
            </div>
        </section>
        
    </main>

    <footer class="text-center py-6 text-gray-500 text-sm">
        Â© 2025 å¤§èˆˆé‡Œç©ºæ°£æ±¡æŸ“æ•¸æ“šæ•…äº‹å ±å‘Š | æ•¸æ“šä¾†æºï¼šGoogle Sheet å³æ™‚å›å ±å–®
    </footer>

    <script>
        let concentrationChart, locationChart, reactionChart, trendChart;
        
        // ğŸš¨ æ›´æ–°ï¼šä½¿ç”¨æ‚¨æä¾›çš„å…¬å…± CSV åŒ¯å‡ºé€£çµ
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSU08cMkQD3qG0_wn4GxHH9Ebo8J3cyDB7oOk1GOjEVi55aB-2_Ks81gYKKoR86I4Ey2oGGX-ZFF3JR/pub?output=csv';
        
        // å‡è¨­çš„ CSV æ¬„ä½ç´¢å¼• (0-based) - æ ¹æ“š Google Form å›æ‡‰è¡¨æ ¼çµæ§‹ï¼Œè«‹æ ¹æ“šæ‚¨çš„å¯¦éš›è¡¨æ ¼èª¿æ•´
        const COLUMN = {
            TIMESTAMP: 0,
            SEVERITY: 1, // ç•°å‘³æ¿ƒåº¦: é‡åº¦/ä¸­åº¦/è¼•åº¦
            LOCATION: 2, // ç™¼ç”Ÿåœ°é»: å®¤å¤–/å®¤å…§
            ODOR_TYPE: 3, // ç•°å‘³é¡å‹: è‡­é…¸å‘³/å—†é¼»å‘³/å…¶ä»–
            REACTIONS: 4, // ä¸è‰¯åæ‡‰: å™å¿ƒ,é ­æšˆ,é ­ç—›,é¼»å­éæ• (é€—è™Ÿåˆ†éš”)
        };

        // --- Utility Functions ---

        function formatTime(date) {
            const pad = (n) => n.toString().padStart(2, '0');
            const y = date.getFullYear();
            const m = pad(date.getMonth() + 1);
            const d = pad(date.getDate());
            const hh = pad(date.getHours());
            const mm = pad(date.getMinutes());
            return `æ›´æ–°æ–¼: ${y}/${m}/${d} ${hh}:${mm}`;
        }
        
        function calculatePercentage(value, total) {
            if (total === 0 || isNaN(total)) return '0%';
            return `${Math.round((value / total) * 100)}%`;
        }

        // --- Data Processing ---
        
        /**
         * Parses CSV text into an array of objects/arrays (rows).
         * Assumes comma separation and quotes for safety.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length <= 1) return []; // Only header or empty
            
            const reports = [];
            // Skip the header row (index 0)
            for (let i = 1; i < lines.length; i++) {
                // Simple CSV parsing: split by comma, handling potential quotes
                // This is a basic parser and might break on complex data (e.g., quotes inside fields)
                const row = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                if (row && row.length > 0) {
                    // Remove surrounding quotes if present
                    const cleanedRow = row.map(cell => cell.startsWith('"') && cell.endsWith('"') ? cell.slice(1, -1) : cell);
                    reports.push(cleanedRow);
                }
            }
            return reports;
        }

        /**
         * Analyzes report data and generates structured metrics for the charts and cards.
         */
        function processReports(reports) {
            const N = reports.length;
            if (N === 0) {
                 // Return empty structure if no data
                return { N: 0, concentration: {}, location: {}, reactions: { labels: [], data: [], total: 0 }, trend: [], odorType: {} };
            }
            
            const concentration = { heavy: 0, medium: 0, light: 0, colors: ['#DC2626', '#FBBF24', '#34D399'] };
            const location = { outdoor: 0, indoor: 0, colors: ['#1D4ED8', '#93C5FD'] };
            const reactionsMap = new Map();
            const odorType = { foul: 0, pungent: 0 };
            const dailyCounts = {};

            reports.forEach(report => {
                // 1. Concentration
                const severity = report[COLUMN.SEVERITY] || '';
                if (severity.includes('é‡åº¦')) concentration.heavy++;
                else if (severity.includes('ä¸­åº¦')) concentration.medium++;
                else if (severity.includes('è¼•åº¦')) concentration.light++;

                // 2. Location
                const loc = report[COLUMN.LOCATION] || '';
                if (loc.includes('å®¤å¤–')) location.outdoor++;
                else if (loc.includes('å®¤å…§')) location.indoor++;

                // 3. Odor Type (using simplified check based on old simulated data)
                const odor = report[COLUMN.ODOR_TYPE] || '';
                if (odor.includes('é…¸è‡­å‘³')) odorType.foul++;
                else if (odor.includes('å—†é¼»å‘³')) odorType.pungent++;

                // 4. Reactions
                const reactionsString = report[COLUMN.REACTIONS] || '';
                // Split by comma and clean up whitespace
                const reactionList = reactionsString.split(',').map(r => r.trim()).filter(r => r);
                reactionList.forEach(reaction => {
                    reactionsMap.set(reaction, (reactionsMap.get(reaction) || 0) + 1);
                });

                // 5. Daily Trend
                const timestamp = report[COLUMN.TIMESTAMP];
                if (timestamp) {
                    try {
                        // Assuming timestamp format is recognized by Date constructor (e.g., YYYY/MM/DD hh:mm:ss)
                        const date = new Date(timestamp);
                        // Format to MM/DD (e.g., 11/05)
                        const dateKey = `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
                        dailyCounts[dateKey] = (dailyCounts[dateKey] || 0) + 1;
                    } catch (e) {
                        console.error('Invalid date format in CSV:', timestamp, e);
                    }
                }
            });

            // Prepare Reactions Data
            const sortedReactions = Array.from(reactionsMap.entries())
                .sort((a, b) => b[1] - a[1]); // Sort by count descending
            const reactionData = {
                labels: sortedReactions.map(item => item[0]),
                data: sortedReactions.map(item => item[1]),
                total: sortedReactions.reduce((sum, item) => sum + item[1], 0),
                colors: ['#A855F7', '#10B981', '#F97316', '#EC4899', '#3B82F6'] // Default colors
            };
            
            // Prepare Trend Data (Last 7 days)
            const today = new Date();
            const trendData = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const dateKey = `${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}`;
                trendData.push({ date: dateKey, count: dailyCounts[dateKey] || 0 });
            }

            return {
                N,
                concentration,
                location,
                reactions: reactionData,
                trend: trendData,
                odorType
            };
        }

        // --- Chart Rendering Functions (Kept almost identical, now using processed data) ---

        function renderConcentrationChart(data, total) {
            const labels = [
                `é‡åº¦ (${calculatePercentage(data.heavy, total)})`, 
                `ä¸­åº¦ (${calculatePercentage(data.medium, total)})`, 
                `è¼•åº¦ (${calculatePercentage(data.light, total)})`
            ].filter((_, i) => [data.heavy, data.medium, data.light][i] > 0); // Filter out zero data points
            const chartData = [data.heavy, data.medium, data.light].filter(val => val > 0);
            const chartColors = data.colors.filter((_, i) => [data.heavy, data.medium, data.light][i] > 0);

            const ctx = document.getElementById('concentrationPieChart').getContext('2d');
            if (concentrationChart) concentrationChart.destroy();
            concentrationChart = new Chart(ctx, {
                type: 'pie',
                data: { labels: labels, datasets: [{ data: chartData, backgroundColor: chartColors, borderColor: '#ffffff', borderWidth: 2 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 14, family: "'Noto Sans TC'" } } },
                        tooltip: { callbacks: { label: (context) => `${context.label}: ${context.parsed} å‰‡` } }
                    }
                }
            });
        }

        function renderLocationChart(data, total) {
            const labels = [
                `å®¤å¤– (${calculatePercentage(data.outdoor, total)})`, 
                `å®¤å…§ (${calculatePercentage(data.indoor, total)})`
            ].filter((_, i) => [data.outdoor, data.indoor][i] > 0);
            const chartData = [data.outdoor, data.indoor].filter(val => val > 0);
            const chartColors = data.colors.filter((_, i) => [data.outdoor, data.indoor][i] > 0);

            const ctx = document.getElementById('locationPieChart').getContext('2d');
            if (locationChart) locationChart.destroy();
            locationChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: chartData, backgroundColor: chartColors, borderColor: '#ffffff', borderWidth: 2 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 14, family: "'Noto Sans TC'" } } },
                        tooltip: { callbacks: { label: (context) => `${context.label}: ${context.parsed} å‰‡` } }
                    }
                }
            });
        }
        
        function renderHealthChart(data) {
            // Use only the top 5 reactions for a clean chart
            const topLabels = data.labels.slice(0, 5);
            const topData = data.data.slice(0, 5);
            const topColors = data.colors.slice(0, 5);

            const dataset = {
                label: 'ä¸è‰¯åæ‡‰æ¬¡æ•¸',
                data: topData,
                backgroundColor: topColors,
                borderRadius: 4
            };

            const ctx = document.getElementById('reactionBarChart').getContext('2d');
            if (reactionChart) reactionChart.destroy();
            reactionChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: topLabels, datasets: [dataset] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, grid: { display: false } },
                        y: { grid: { display: true, drawBorder: false }, ticks: { font: { size: 14, family: "'Noto Sans TC'" } } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (context) => ` ${context.parsed.x} æ¬¡` } }
                    }
                }
            });
        }
        
        function renderTrendChart(trendData) {
            const labels = trendData.map(d => d.date);
            const data = trendData.map(d => d.count);

            const ctx = document.getElementById('trendLineChart').getContext('2d');
            if (trendChart) trendChart.destroy();
            
            trendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ¯æ—¥å›å ±æ•¸é‡',
                        data: data,
                        backgroundColor: (context) => {
                            if (context.dataIndex === trendData.length - 1) {
                                return '#10B981'; // Green for the most recent day
                            } else if (context.parsed.y > 0) {
                                return '#EF4444'; // Red for days with reports
                            } else {
                                return '#9CA3AF'; // Gray for zero days
                            }
                        }, 
                        borderColor: '#DC2626', 
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'å›å ±æ•¸', font: { family: "'Noto Sans TC'", size: 14 } },
                            ticks: { precision: 0 }
                        },
                        x: {
                            title: { display: true, text: 'æ—¥æœŸ (éå»7å¤©)', font: { family: "'Noto Sans TC'", size: 14 } },
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }, 
                        tooltip: { callbacks: { label: (context) => ` ${context.dataset.label}: ${context.parsed.y} å‰‡` } }
                    }
                }
            });
        }
        
        // --- Core Update Function ---

        function updateMetricCards(data, heavyPercent, outdoorPercent) {
            const cards = [
                { id: 'card-n', textId: 'metric-n', value: data.N },
                { id: 'card-heavy', textId: 'metric-heavy-percent', value: heavyPercent },
                { id: 'card-outdoor', textId: 'metric-outdoor-percent', value: outdoorPercent }
            ];

            cards.forEach(card => {
                const cardElement = document.getElementById(card.id);
                const textElement = document.getElementById(card.textId);
                
                // Check if value has changed before adding the pulse-update class
                const currentValue = textElement.textContent;
                const newValue = String(card.value);

                if (textElement && currentValue !== newValue) {
                    cardElement.classList.add('active-update');
                    // Remove the animation class after it runs
                    setTimeout(() => cardElement.classList.remove('active-update'), 1500); 
                }
                
                if (textElement) textElement.textContent = newValue;
            });
        }

        function updateUI(processedData) {
            const N = processedData.N;
            
            // 1. Calculate and update text metrics
            const heavyPercent = calculatePercentage(processedData.concentration.heavy, N);
            const outdoorPercent = calculatePercentage(processedData.location.outdoor, N);
            
            updateMetricCards(processedData, heavyPercent, outdoorPercent);
            
            // 2. Update descriptive text elements
            document.getElementById('conc-heavy-percent').textContent = heavyPercent.replace('%', '');
            document.getElementById('reaction-n-count').textContent = `N=${processedData.reactions.total}`;
            
            document.getElementById('odor-foul-count').textContent = `${processedData.odorType.foul} å‰‡å›å ± (ä¸»è¦é¡å‹)`;
            document.getElementById('odor-pungent-count').textContent = `${processedData.odorType.pungent} å‰‡å›å ±`;
            
            // 3. Update Charts
            renderConcentrationChart(processedData.concentration, N);
            renderLocationChart(processedData.location, N);
            renderHealthChart(processedData.reactions);
            renderTrendChart(processedData.trend);
            
            // 4. Update Time Peaks (Placeholder, needs real-time analysis but for this scope, let's just update based on N)
            const timePeaksList = document.getElementById('time-peaks-list');
            if (timePeaksList) {
                timePeaksList.innerHTML = `
                    <li>**å ±å‘Šç¸½æ•¸ï¼š** ${N} å‰‡ (å³æ™‚æ›´æ–°)</li>
                    <li>**é‡åº¦ä½”æ¯”ï¼š** ${heavyPercent}</li>
                    <li><span class="font-bold text-red-600">**æœ€å¸¸ç™¼ç”Ÿç—‡ç‹€ï¼š** ${processedData.reactions.labels.length > 0 ? processedData.reactions.labels[0] : 'ç„¡æ•¸æ“š'}</span></li>
                `;
            }

            // 5. Update Timestamp
            document.getElementById('last-update').textContent = formatTime(new Date());
            document.getElementById('loading-status').textContent = ''; // Clear status
        }
        
        async function fetchAndUpdateData() {
            const statusElement = document.getElementById('loading-status');
            statusElement.textContent = 'æ­£åœ¨è®€å– Google Sheet æœ€æ–°è³‡æ–™...';
            console.log('Fetching data from:', CSV_URL);

            try {
                // Use the publicly published CSV export URL
                const response = await fetch(CSV_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}. æ•¸æ“šæºç„¡æ³•å­˜å–ã€‚`);
                }
                
                const csvText = await response.text();
                
                const reports = parseCSV(csvText);
                const processedData = processReports(reports);
                
                updateUI(processedData);

            } catch (error) {
                console.error('Error fetching or processing data:', error);
                // Display error message to the user
                statusElement.textContent = `ğŸš¨ è³‡æ–™è¼‰å…¥å¤±æ•—: ${error.message}`;
            }
        }
        
        // --- Initialization and Interval Setup ---

        document.addEventListener('DOMContentLoaded', () => {
            fetchAndUpdateData();
            
            // è¨­å®šè‡ªå‹•æ›´æ–°ï¼šæ¯ 10 åˆ†é˜ (600,000 æ¯«ç§’) è®€å–ä¸€æ¬¡ Google Sheet
            const updateInterval = 600000; 
            setInterval(fetchAndUpdateData, updateInterval); 
            
            // ç¢ºä¿åœ–è¡¨åœ¨è¦–çª—å¤§å°æ”¹è®Šæ™‚éŸ¿æ‡‰æ€§åœ°é‡ç¹ª
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    // Re-run the update to destroy and re-render charts
                    fetchAndUpdateData(); 
                }, 250); 
            });
        });
    </script>
</body>
</html>
